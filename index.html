<html>
  <head>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: sans-serif;
      }

      nav {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
      }

      nav a {
        color: black;
        font-size: small;
      }

      form {
        display: flex;
        flex-direction: column;
        margin: 0.75rem;
        padding: 1rem;
        border: black solid 1px;
      }

      input,
      button {
        margin: 0.25rem;
        flex: 1;
      }

      li,
      div,
      h2 {
        padding: 0.75rem;
      }

      a {
        flex: 2;
      }

      .selected {
        padding: 0.75rem;

        background-color: teal;
      }

      .selected > a {
        color: white;
      }

      .bookmarks {
        display: flex;
        justify-content: space-around;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script
      src="https://unpkg.com/react@16/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.0/react-router-dom.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { Component } = React
      const { HashRouter, Link, Route, Switch, Redirect } = ReactRouterDOM
      const API = 'https://acme-users-api-rev.herokuapp.com/api'

      const fetchUser = async () => {
        const storage = window.localStorage
        const userId = storage.getItem('userId')

        if (userId) {
          try {
            return (await axios.get(`${API}/users/detail/${userId}`)).data
          } catch (ex) {
            storage.removeItem('userId')
            return fetchUser
          }
        }

        const user = (await axios.get(`${API}/users/random`)).data
        storage.setItem('userId', user.id)
        return user
      }

      const fetchBookmarks = async userId => {
        try {
          return (await axios.get(`${API}/users/${userId}/bookmarks`)).data
        } catch (ex) {
          console.log(ex)
          return []
        }
      }

      const createCategories = bookmarks => {
        return bookmarks.reduce((acc, bookmark) => {
          if (!acc.hasOwnProperty(bookmark.category)) acc[bookmark.category] = 1
          else acc[bookmark.category] += 1
          acc.all = bookmarks.length
          return acc
        }, {})
      }

      const Nav = ({ filter, categories }) => {
        const navTabs = Object.keys(categories).sort()

        return (
          <nav>
            {navTabs.map(navTab => (
              <div
                key={navTab}
                className={filter === `${navTab}` ? 'selected' : ''}>
                <Link to={`/${navTab}`}>
                  {`${navTab.toUpperCase()} (${categories[navTab]})`}
                </Link>
              </div>
            ))}
          </nav>
        )
      }

      class CreateBookmark extends Component {
        constructor() {
          super()
          this.state = {
            category: '',
            url: '',
            rating: 1
          }
          this.createNew = this.createNew.bind(this)
        }

        createNew(category, url, rating) {
          const bookmark = { category, url, rating }
          this.props
            .create(bookmark)
            .then(() => this.props.history.push(`/${category}`))
            .catch(ex => {
              console.log(ex)
              alert(ex.response.data.message)
            })
            .then(
              this.setState({
                category: '',
                url: ''
              })
            )
        }

        render() {
          const { category, url, rating } = this.state
          const disabled = !url || !category ? 'disabled' : ''
          return (
            <form id="createBookmarkForm" onSubmit={ev => ev.preventDefault()}>
              <input
                name="url"
                placeholder="url"
                value={url}
                onChange={ev => this.setState({ url: ev.target.value })}
              />
              <input
                name="category"
                placeholder="category"
                value={category}
                onChange={ev =>
                  this.setState({ category: ev.target.value.toLowerCase() })
                }
              />
              <button
                disabled={disabled}
                onClick={() => {
                  this.createNew(category, url, rating)
                }}>
                Create
              </button>
            </form>
          )
        }
      }

      const Bookmarks = ({ filter, bookmarks, destroy }) => {
        const renderBookmarks = bookmarks => {
          return bookmarks.map(bookmark => {
            return (
              <li className="bookmarks" key={bookmark.id}>
                <a href={`${bookmark.url}`} target="_blank">
                  {bookmark.url}
                </a>
                <button
                  onClick={() => {
                    destroy(bookmark)
                  }}>
                  Destory
                </button>
              </li>
            )
          })
        }

        if (filter === 'all') {
          return <ul>{renderBookmarks(bookmarks)}</ul>
        } else {
          const filtered = bookmarks.filter(
            bookmark => bookmark.category === filter
          )
          return <ul>{renderBookmarks(filtered)}</ul>
        }
      }

      class App extends Component {
        constructor() {
          super()
          this.state = {
            user: {},
            bookmarks: [],
            categories: {}
          }
          this.destroy = this.destroy.bind(this)
          this.create = this.create.bind(this)
        }

        async componentDidMount() {
          const user = await fetchUser()
          const bookmarks = await fetchBookmarks(user.id)
          const categories = createCategories(bookmarks)

          this.setState({ user, bookmarks, categories })
        }

        async destroy(bookmark) {
          const { id } = bookmark
          const { user, bookmarks } = this.state
          await axios.delete(`${API}/users/${user.id}/bookmarks/${id}`)

          const updatedBookmarks = bookmarks.filter(
            bookmark => bookmark.id !== id
          )

          this.setState({
            bookmarks: updatedBookmarks,
            categories: createCategories(updatedBookmarks)
          })
        }

        async create(bookmark) {
          const { category, url, rating } = bookmark
          const { user, bookmarks } = this.state

          const newBookmark = (
            await axios.post(`${API}/users/${user.id}/bookmarks`, {
              url,
              category,
              rating
            })
          ).data

          this.setState({
            bookmarks: [...bookmarks, newBookmark],
            categories: createCategories([...bookmarks, newBookmark])
          })
        }

        render() {
          const { user, bookmarks, categories } = this.state
          const { destroy, create } = this
          return (
            <HashRouter>
              <h2 id="title">{`${user.fullName} (${bookmarks.length} Bookmark${
                bookmarks.length === 1 ? '' : 's'
              })`}</h2>
              <Route
                path="/:filter?"
                render={({ history, match }) => (
                  <main>
                    <Nav filter={match.params.filter} categories={categories} />
                    <CreateBookmark history={history} create={create} />
                    <Bookmarks
                      filter={match.params.filter}
                      bookmarks={bookmarks}
                      destroy={destroy}
                    />
                  </main>
                )}
              />
            </HashRouter>
          )
        }
      }

      const root = document.querySelector('#root')
      ReactDOM.render(<App />, root)
    </script>
  </body>
</html>
