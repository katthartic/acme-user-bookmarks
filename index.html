<html>
  <head>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: sans-serif;
      }

      #createBookmarkForm {
        display: flex;
        flex-direction: column;
        margin: 0.75rem;
        padding: 1rem;
        border: black solid 1px;
      }

      input,
      button {
        margin: 0.25rem;
        flex: 1;
      }

      nav {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
      }

      .link {
        color: black;
        font-size: small;
      }

      div,
      h2 {
        padding: 0.75rem;
      }

      a {
        flex: 2;
      }

      .selected {
        padding: 0.75rem;

        background-color: teal;
      }

      .selected > .link {
        color: white;
      }

      .bookmarks {
        display: flex;
        justify-content: space-around;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script
      src="https://unpkg.com/react@16/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.0/react-router-dom.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { Component } = React
      const { HashRouter, Link, Route, Switch, Redirect } = ReactRouterDOM
      const API = 'https://acme-users-api-rev.herokuapp.com/api'

      const fetchUser = async () => {
        const storage = window.localStorage
        const userId = storage.getItem('userId')

        if (userId) {
          try {
            return (await axios.get(`${API}/users/detail/${userId}`)).data
          } catch (ex) {
            storage.removeItem('userId')
            return fetchUser
          }
        }

        const user = (await axios.get(`${API}/users/random`)).data
        storage.setItem('userId', user.id)
        return user
      }

      const fetchBookmarks = async userId => {
        try {
          return (await axios.get(`${API}/users/${userId}/bookmarks`)).data
        } catch (ex) {
          console.log(ex)
          return []
        }
      }

      const createCategories = bookmarks => {
        return bookmarks.reduce((acc, bookmark) => {
          if (!acc.hasOwnProperty(bookmark.category)) acc[bookmark.category] = 1
          else acc[bookmark.category] += 1
          return acc
        }, {})
      }

      const Nav = ({ path, categories }) => {
        console.log('Nav', path, categories)
        const headers = Object.keys(categories).sort()

        return (
          <nav>
            {headers.map(header => (
              <div
                key={header}
                className={path === `/${header}` ? 'selected' : 'navTab'}>
                <Link to={`/${header}`} className="link">
                  {`${header.toUpperCase()} (${categories[header]})`}
                </Link>
              </div>
            ))}
          </nav>
        )
      }

      class CreateBookmark extends Component {
        constructor() {
          super()
          this.state = {
            category: '',
            url: '',
            rating: 1
          }
          this.createNew = this.createNew.bind(this)
        }

        createNew(category, url, rating) {
          console.log('history', this.props.history)
          const bookmark = { category, url, rating }
          this.props
            .create(bookmark)
            // .then(() => this.props.history.push(`/${category}`)) //TODO: Test
            .catch(ex => {
              console.log(ex)
              alert(ex.response.data.message)
            })
            .then(
              this.setState({
                category: '',
                url: ''
              })
            )
        }

        render() {
          const { category, url, rating } = this.state
          const disabled = !url || !category ? 'disabled' : ''
          return (
            <form id="createBookmarkForm" onSubmit={ev => ev.preventDefault()}>
              <input
                name="url"
                placeholder="url"
                value={url}
                onChange={ev => this.setState({ url: ev.target.value })}
              />
              <input
                name="category"
                placeholder="category"
                value={category}
                onChange={ev =>
                  this.setState({ category: ev.target.value.toLowerCase() })
                }
              />
              <button
                disabled={disabled}
                onClick={() => {
                  this.createNew(category, url, rating)
                }}>
                Create
              </button>
            </form>
          )
        }
      }

      const Bookmarks = ({ pathCategory, bookmarks, destroy }) => {
        return bookmarks
          .filter(bookmark => bookmark.category === pathCategory)
          .map(bookmark => {
            return (
              <div className="bookmarks" key={bookmark.id}>
                <a href={`${bookmark.url}`}>{bookmark.url}</a>
                <button
                  onClick={() => {
                    destroy(bookmark)
                  }}>
                  Destory
                </button>
              </div>
            )
          })
      }

      class App extends Component {
        constructor() {
          super()
          this.state = {
            user: {},
            bookmarks: [],
            categories: {}
          }
          this.destroy = this.destroy.bind(this)
          this.update = this.update.bind(this)
          this.create = this.create.bind(this)
        }

        // conponentDidUpdate() {
        //   const categories = createCategories(this.bookmarks)
        //   this.setState({ categories })
        // }

        async componentDidMount() {
          const user = await fetchUser()
          const bookmarks = await fetchBookmarks(user.id)
          const categories = createCategories(bookmarks)

          this.setState({ user, bookmarks, categories })
        }

        async destroy(bookmark) {
          const { id } = bookmark
          const { user, bookmarks } = this.state
          await axios.delete(`${API}/users/${user.id}/bookmarks/${id}`)

          //TODO Need state update
          const updatedBookmarks = bookmarks.filter(
            bookmark => bookmark.id !== id
          )

          this.setState({
            bookmarks: updatedBookmarks,
            categories: createCategories(updatedBookmarks)
          })
        }

        async update(bookmark) {
          //TODO Test
          const { id, category, url, rating } = bookmark
          const { user, bookmarks } = this.state

          const updatedBookmark = (await axios.put(
            `${API}/users/${user.id}/bookmarks/${id}`
          ),
          {
            url,
            category,
            rating
          }).data

          //TODO Need state update
        }

        async create(bookmark) {
          const { category, url, rating } = bookmark
          const { user, bookmarks } = this.state

          const newBookmark = (
            await axios.post(`${API}/users/${user.id}/bookmarks`, {
              url,
              category,
              rating
            })
          ).data

          this.setState({
            bookmarks: [...bookmarks, newBookmark],
            categories: createCategories([...bookmarks, newBookmark])
          })
        }

        render() {
          console.log('render', this.state)
          const { user, bookmarks, categories } = this.state
          const { destroy, update, create } = this
          return (
            <HashRouter>
              <h2 id="title">{`${user.fullName} (${bookmarks.length} Bookmark${
                bookmarks.length === 1 ? '' : 's'
              })`}</h2>
              <Route
                render={({ location }) => (
                  <Nav path={location.pathname} categories={categories} />
                )}
              />
              <CreateBookmark history={history} create={create} />
              <Switch>
                {Object.keys(categories).map(category => {
                  return (
                    <Route
                      key={category}
                      path={`/${category}`}
                      render={() => (
                        <Bookmarks
                          pathCategory={category}
                          bookmarks={bookmarks}
                          destroy={destroy}
                        />
                      )}
                    />
                  )
                })}
              </Switch>
            </HashRouter>
          )
        }
      }

      const root = document.querySelector('#root')
      ReactDOM.render(<App />, root)
    </script>
  </body>
</html>
